openapi: 3.0.3
info:
  title: DexSwipe Backend API
  version: 0.1.0
  description: |
    Supabase Edge Functions 기반 API.
    - Public API: get-feed
servers:
  - url: https://{project_ref}.supabase.co
    variables:
      project_ref:
        default: kkpjxhmgxtqhlaimotbf
paths:
  /functions/v1/get-feed:
    get:
      summary: Get swipe feed tokens
      description: |
        Returns swipe feed tokens.
        - Data source: `public.tokens` (denormalized, lean for free-tier)
        - Pagination: cursor (keyset) using `tokens.updated_at`
        - Anti-join: excludes already seen tokens via `seen_tokens(user_device_id, token_id)`
        - Risk filter: excludes security/risky tokens unless `include_risky=true`
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema:
            type: string
          description: Client/device identifier used for anti-join (seen_tokens).
        - in: query
          name: format
          schema:
            type: string
            enum: [full, min]
            default: full
          description: |
            `full`: object response with `tokens[]` + `next_cursor`.
            `min`: flat JSON array response (mobile-optimized) + `x-next-cursor` header.
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 30
        - in: query
          name: cursor
          description: Keyset cursor (ISO timestamp). Returns items with `updated_at < cursor`.
          schema:
            type: string
            format: date-time
        - in: query
          name: chains
          description: Comma-separated chain ids (e.g. "solana,base"). Supported: solana, base, sui, tron.
          schema:
            type: string
        - in: query
          name: min_liquidity_usd
          schema:
            type: number
        - in: query
          name: min_volume_24h
          schema:
            type: number
        - in: query
          name: min_fdv
          schema:
            type: number
        - in: query
          name: include_risky
          description: If true, include tokens flagged as phishing/rugpull risk (default false).
          schema:
            type: boolean
      responses:
        "200":
          description: OK
          headers:
            x-next-cursor:
              description: Present when `format=min` (empty string when no more).
              schema:
                type: string
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/FeedResponseFull"
                  - $ref: "#/components/schemas/FeedResponseMin"
  /functions/v1/wishlist:
    get:
      summary: List wishlist items (per device)
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema: { type: string }
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 100
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      required: [token_id, created_at]
                      properties:
                        token_id: { type: string }
                        created_at: { type: string, format: date-time }
                        captured_price: { type: number, nullable: true }
                        captured_at: { type: string, format: date-time, nullable: true }
                  limit: { type: integer }
    post:
      summary: Add to wishlist (per device)
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token_id]
              properties:
                token_id: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  token_id: { type: string }
                  created_at: { type: string, format: date-time }
                  captured_price: { type: number, nullable: true }
                  captured_at: { type: string, format: date-time }
    delete:
      summary: Remove from wishlist (per device)
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema: { type: string }
        - in: query
          name: token_id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  token_id: { type: string }
  /functions/v1/get-wishlist:
    get:
      summary: Get wishlist ROI (lazy refresh)
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema: { type: string }
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 100
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/WishlistItem"
                  limit: { type: integer }
                  refreshed:
                    type: object
                    properties:
                      requested: { type: integer }
                      updated: { type: integer }
components:
  schemas:
    FeedResponseFull:
      type: object
      properties:
        tokens:
          type: array
          items:
            $ref: "#/components/schemas/FeedItemFull"
        limit:
          type: integer
        cursor:
          type: string
          nullable: true
          format: date-time
        next_cursor:
          type: string
          nullable: true
          format: date-time
        notes:
          type: object
    FeedResponseMin:
      type: array
      items:
        $ref: "#/components/schemas/FeedItemMin"
    FeedItemFull:
      type: object
      required: [token_id, chain_id, token_address, updated_at]
      properties:
        token_id:
          type: string
        chain_id:
          type: string
        token_address:
          type: string
        name: { type: string, nullable: true }
        symbol: { type: string, nullable: true }
        logo_url: { type: string, nullable: true }
        website_url: { type: string, nullable: true }
        price_usd: { type: number, nullable: true }
        liquidity_usd: { type: number, nullable: true }
        volume_24h: { type: number, nullable: true }
        fdv: { type: number, nullable: true }
        market_cap: { type: number, nullable: true }
        price_change_5m: { type: number, nullable: true }
        price_change_15m: { type: number, nullable: true }
        price_change_1h: { type: number, nullable: true }
        is_surging: { type: boolean, nullable: true }
        safety_score:
          type: integer
          minimum: 0
          maximum: 100
          nullable: true
        buys_24h: { type: integer, nullable: true }
        sells_24h: { type: integer, nullable: true }
        pair_created_at: { type: string, nullable: true, format: date-time }
        updated_at: { type: string, format: date-time }
        security:
          nullable: true
          type: object
          properties:
            always_deny: { type: boolean }
            deny_reasons:
              type: array
              items: { type: string }
            scanned_at:
              type: string
              format: date-time
              nullable: true
        quality:
          nullable: true
          type: object
          properties:
            url_risk:
              nullable: true
              type: object
              properties:
                is_phishing: { type: boolean, nullable: true }
                dapp_risk_level: { type: string, nullable: true }
                scanned_at: { type: string, format: date-time, nullable: true }
            rugpull:
              nullable: true
              type: object
              properties:
                is_rugpull_risk: { type: boolean, nullable: true }
                risk_level: { type: string, nullable: true }
                scanned_at: { type: string, format: date-time, nullable: true }
    FeedItemMin:
      type: object
      required: [id, chain_id, is_security_risk, safety_score, is_surging]
      properties:
        id: { type: string }
        chain_id: { type: string }
        logo_url: { type: string, nullable: true }
        symbol: { type: string, nullable: true }
        price_change_5m: { type: number, nullable: true }
        price_change_15m: { type: number, nullable: true }
        price_change_1h: { type: number, nullable: true }
        is_security_risk: { type: boolean }
        safety_score:
          type: integer
          minimum: 0
          maximum: 100
        is_surging: { type: boolean }

    WishlistItem:
      type: object
      required: [token_id, chain_id, token_address, captured_price, current_price, roi_since_captured, safety_score, is_surging, updated_at]
      properties:
        token_id: { type: string }
        chain_id: { type: string }
        token_address: { type: string }
        symbol: { type: string, nullable: true }
        logo_url: { type: string, nullable: true }
        captured_price: { type: number, nullable: true }
        captured_at: { type: string, format: date-time, nullable: true }
        current_price: { type: number, nullable: true }
        roi_since_captured: { type: number, nullable: true }
        price_change_5m: { type: number, nullable: true }
        price_change_1h: { type: number, nullable: true }
        is_surging: { type: boolean }
        is_security_risk: { type: boolean }
        safety_score:
          type: integer
          minimum: 0
          maximum: 100
        updated_at: { type: string, format: date-time }

