openapi: 3.0.3
info:
  title: DexSwipe Backend API
  version: 0.1.0
  description: |
    Supabase Edge Functions 기반 API.
    - Public API: get-feed
servers:
  - url: https://{project_ref}.supabase.co
    variables:
      project_ref:
        default: kkpjxhmgxtqhlaimotbf
paths:
  /functions/v1/get-feed:
    get:
      summary: Get swipe feed tokens
      description: |
        Returns swipe feed tokens.
        - Data source: `public.tokens` (denormalized, lean for free-tier)
        - Pagination: cursor (keyset) using `tokens.updated_at`
        - Anti-join: excludes already seen tokens via `seen_tokens(user_device_id, token_id)`
        - Risk filter: excludes security/risky tokens unless `include_risky=true`
        - Note: Depending on server's GoPlus plan tier, GoPlus fields may be cache-only. In that case, tokens can stay `checks_state=pending` (and `safety_score=null`) until background workers complete scans.
        - GoPlus auth: Token Security API expects `Authorization: Bearer <access_token>`. The server can mint/refresh the access token via GoPlus Access Token API (`/api/v1/token`) using `app_key + sign(sha1(app_key+time+app_secret)) + time`.
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema:
            type: string
          description: Client/device identifier used for anti-join (seen_tokens).
        - in: query
          name: format
          schema:
            type: string
            enum: [full, min]
            default: full
          description: |
            `full`: object response with `tokens[]` + `next_cursor`.
            `min`: flat JSON array response (mobile-optimized) + `x-next-cursor` header.
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 20
            default: 20
        - in: query
          name: cursor
          description: Keyset cursor (ISO timestamp). Returns items with `updated_at < cursor`.
          schema:
            type: string
            format: date-time
        - in: query
          name: chains
          description: Comma-separated chain ids (e.g. "solana,base"). Supported (Intersection Rule): solana, base, bsc, ethereum, arbitrum, polygon, avalanche, tron.
          schema:
            type: string
        - in: query
          name: min_liquidity_usd
          schema:
            type: number
        - in: query
          name: min_volume_24h
          schema:
            type: number
        - in: query
          name: min_fdv
          schema:
            type: number
        - in: query
          name: include_risky
          description: If true, include tokens flagged as phishing/rugpull risk (default false).
          schema:
            type: boolean
        - in: query
          name: allow_repeat
          description: If true, do not exclude already seen tokens (seen_tokens anti-join bypass). Default false.
          schema:
            type: boolean
        - in: query
          name: include_scanning
          description: |
            If true, include tokens whose checks are not complete yet (e.g. `pending`/`limited`) or `unsupported`.
            Default: true (recommended for fresh DB / cold start).
          schema:
            type: boolean
      responses:
        "200":
          description: OK
          headers:
            x-next-cursor:
              description: Present when `format=min` (empty string when no more).
              schema:
                type: string
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/FeedResponseFull"
                  - $ref: "#/components/schemas/FeedResponseMin"
  /functions/v1/wishlist:
    get:
      summary: List wishlist items (per device)
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema: { type: string }
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 100
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      required: [token_id, created_at]
                      properties:
                        token_id: { type: string }
                        created_at: { type: string, format: date-time }
                        captured_price: { type: number, nullable: true }
                        captured_at: { type: string, format: date-time, nullable: true }
                  limit: { type: integer }
    post:
      summary: Add to wishlist (per device)
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token_id]
              properties:
                token_id: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  token_id: { type: string }
                  created_at: { type: string, format: date-time }
                  captured_price: { type: number, nullable: true }
                  captured_at: { type: string, format: date-time }
    delete:
      summary: Remove from wishlist (per device)
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema: { type: string }
        - in: query
          name: token_id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  token_id: { type: string }
  /functions/v1/get-wishlist:
    get:
      summary: Get wishlist (live price sync + GoPlus merge)
      description: |
        Returns wishlist items with live DexScreener prices and merged GoPlus signals.
        - If GoPlus checks are not complete yet, `checks_state` can be `pending|limited|unsupported` and `safety_score` will be null.
        - Depending on server's GoPlus plan tier, GoPlus signals may be served cache-only (no live calls from this endpoint).
        - GoPlus auth: Token Security API expects `Authorization: Bearer <access_token>`. The server can mint/refresh the access token via GoPlus Access Token API (`/api/v1/token`) using `app_key + sign(sha1(app_key+time+app_secret)) + time`.
      parameters:
        - in: header
          name: x-client-id
          required: true
          schema: { type: string }
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 100
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/WishlistItem"
                  limit: { type: integer }
                  refreshed:
                    type: object
                    properties:
                      requested: { type: integer }
                      updated: { type: integer }
components:
  schemas:
    FeedResponseFull:
      type: object
      properties:
        tokens:
          type: array
          items:
            $ref: "#/components/schemas/FeedItemFull"
        limit:
          type: integer
        cursor:
          type: string
          nullable: true
          format: date-time
        next_cursor:
          type: string
          nullable: true
          format: date-time
        notes:
          type: object
    FeedResponseMin:
      type: array
      items:
        $ref: "#/components/schemas/FeedItemMin"
    FeedItemFull:
      type: object
      required: [token_id, chain_id, token_address, updated_at]
      properties:
        token_id:
          type: string
        chain_id:
          type: string
        token_address:
          type: string
        name: { type: string, nullable: true }
        symbol: { type: string, nullable: true }
        logo_url:
          type: string
          nullable: true
          description: "May be null when provider does not supply an icon. UI should fallback to a placeholder/chain icon."
        website_url: { type: string, nullable: true }
        official_website_url: { type: string, nullable: true }
        dex_chart_url: { type: string, nullable: true }
        twitter_url: { type: string, nullable: true }
        telegram_url: { type: string, nullable: true }
        price_usd: { type: number, nullable: true }
        liquidity_usd: { type: number, nullable: true }
        volume_24h: { type: number, nullable: true }
        buys_24h: { type: integer, nullable: true }
        sells_24h: { type: integer, nullable: true }
        txns_24h: { type: integer, nullable: true }
        fdv: { type: number, nullable: true }
        market_cap: { type: number, nullable: true }
        price_change_5m: { type: number, nullable: true }
        price_change_15m: { type: number, nullable: true }
        price_change_1h: { type: number, nullable: true }
        is_surging: { type: boolean }
        is_security_risk: { type: boolean }
        risk_factors:
          type: array
          description: "Human-readable reasons for safety_score/checks_state. May include explicit provider notes like 'Checks Limited (GoPlus code 7013: Address format error!)'."
          items: { type: string }
        safety_score:
          type: integer
          minimum: 0
          maximum: 100
          nullable: true
          description: "Null when checks are not complete (checks_state=pending|limited|unsupported). UI should render '-' for null."
        updated_at: { type: string, format: date-time }
        goplus_status:
          type: string
          description: "GoPlus merge status: live|cached|stale|pending|limited|unsupported"
        checks_state:
          type: string
          description: "Checks completeness: pending|complete|limited|unsupported"
        goplus_scanned_at: { type: string, format: date-time, nullable: true }
        goplus_cannot_sell: { type: boolean, nullable: true }
        goplus_is_honeypot: { type: boolean, nullable: true }
        goplus_is_blacklisted: { type: boolean, nullable: true }
        goplus_cannot_sell_all: { type: boolean, nullable: true }
        goplus_buy_tax: { type: number, nullable: true }
        goplus_sell_tax: { type: number, nullable: true }
        goplus_trust_list: { type: boolean, nullable: true }
        goplus_is_proxy: { type: boolean, nullable: true }
        goplus_transfer_pausable: { type: boolean, nullable: true }
        goplus_slippage_modifiable: { type: boolean, nullable: true }
        goplus_external_call: { type: boolean, nullable: true }
        goplus_owner_change_balance: { type: boolean, nullable: true }
        goplus_hidden_owner: { type: boolean, nullable: true }
        goplus_cannot_buy: { type: boolean, nullable: true }
        goplus_trading_cooldown: { type: boolean, nullable: true }
        goplus_is_open_source: { type: boolean, nullable: true }
        goplus_is_mintable: { type: boolean, nullable: true }
        goplus_take_back_ownership: { type: boolean, nullable: true }
        urls:
          type: object
          nullable: true
          properties:
            official_website: { type: string, nullable: true }
            dex_chart: { type: string, nullable: true }
            twitter: { type: string, nullable: true }
            telegram: { type: string, nullable: true }
    FeedItemMin:
      type: object
      required: [token_id, chain_id, token_address, is_security_risk, safety_score, is_surging, goplus_status, checks_state, risk_factors]
      properties:
        token_id: { type: string, description: "Canonical token id: <chain_id>:<token_address>" }
        chain_id: { type: string }
        token_address: { type: string }
        logo_url:
          type: string
          nullable: true
          description: "May be null when provider does not supply an icon. UI should fallback to a placeholder/chain icon."
        symbol: { type: string, nullable: true }
        official_website_url: { type: string, nullable: true }
        dex_chart_url: { type: string, nullable: true }
        twitter_url: { type: string, nullable: true }
        telegram_url: { type: string, nullable: true }
        price_usd: { type: number, nullable: true }
        liquidity_usd: { type: number, nullable: true }
        volume_24h: { type: number, nullable: true }
        fdv: { type: number, nullable: true }
        txns_24h: { type: integer, nullable: true }
        price_change_5m: { type: number, nullable: true }
        price_change_1h: { type: number, nullable: true }
        is_security_risk: { type: boolean }
        risk_factors:
          type: array
          description: "Human-readable reasons for safety_score/checks_state. May include explicit provider notes like 'Checks Limited (GoPlus code 7013: Address format error!)'."
          items: { type: string }
        safety_score:
          type: integer
          minimum: 0
          maximum: 100
          nullable: true
          description: "Null when checks are not complete (checks_state=pending|limited|unsupported). UI should render '-' for null."
        is_surging: { type: boolean }
        goplus_status:
          type: string
          description: "GoPlus merge status: live|cached|stale|pending|limited|unsupported"
        checks_state:
          type: string
          description: "Checks completeness: pending|complete|limited|unsupported"
        goplus_is_honeypot: { type: boolean, nullable: true }
        goplus_buy_tax: { type: number, nullable: true }
        goplus_sell_tax: { type: number, nullable: true }
        goplus_trust_list: { type: boolean, nullable: true }
        goplus_is_blacklisted: { type: boolean, nullable: true }

    WishlistItem:
      type: object
      required:
        [
          token_id,
          chain_id,
          token_address,
          captured_price,
          current_price,
          roi_since_captured,
          safety_score,
          is_security_risk,
          risk_factors,
          checks_state,
          is_surging,
          updated_at,
          goplus_status
        ]
      properties:
        token_id: { type: string }
        chain_id: { type: string }
        token_address: { type: string }
        symbol: { type: string, nullable: true }
        logo_url:
          type: string
          nullable: true
          description: "May be null when provider does not supply an icon. UI should fallback to a placeholder/chain icon."
        official_website_url: { type: string, nullable: true }
        dex_chart_url: { type: string, nullable: true }
        twitter_url: { type: string, nullable: true }
        telegram_url: { type: string, nullable: true }
        captured_price: { type: number, nullable: true }
        captured_at: { type: string, format: date-time, nullable: true }
        current_price: { type: number, nullable: true }
        roi_since_captured: { type: number, nullable: true }
        price_change_5m: { type: number, nullable: true }
        price_change_1h: { type: number, nullable: true }
        is_surging: { type: boolean }
        safety_score:
          type: integer
          minimum: 0
          maximum: 100
          nullable: true
          description: "Null when checks are not complete (checks_state=pending|limited|unsupported). UI should render '-' for null."
        is_security_risk: { type: boolean }
        risk_factors:
          type: array
          description: "Human-readable reasons for safety_score/checks_state. May include explicit provider notes like 'Checks Limited (GoPlus code 7013: Address format error!)'."
          items: { type: string }
        updated_at: { type: string, format: date-time }
        goplus_status:
          type: string
          description: "GoPlus merge status: live|cached|stale|pending|limited|unsupported"
        checks_state:
          type: string
          description: "Checks completeness: pending|complete|limited|unsupported. When not complete, safety_score and all goplus_* detail fields are null."
        goplus_is_honeypot: { type: boolean, nullable: true }
        goplus_is_blacklisted: { type: boolean, nullable: true }
        goplus_cannot_sell_all: { type: boolean, nullable: true }
        goplus_buy_tax: { type: number, nullable: true }
        goplus_sell_tax: { type: number, nullable: true }
        goplus_trust_list: { type: boolean, nullable: true }
        goplus_is_proxy: { type: boolean, nullable: true }
        goplus_transfer_pausable: { type: boolean, nullable: true }
        goplus_slippage_modifiable: { type: boolean, nullable: true }
        goplus_external_call: { type: boolean, nullable: true }
        goplus_owner_change_balance: { type: boolean, nullable: true }
        goplus_hidden_owner: { type: boolean, nullable: true }
        goplus_cannot_buy: { type: boolean, nullable: true }
        goplus_trading_cooldown: { type: boolean, nullable: true }
        goplus_is_open_source: { type: boolean, nullable: true }
        goplus_is_mintable: { type: boolean, nullable: true }
        goplus_take_back_ownership: { type: boolean, nullable: true }
        urls:
          type: object
          nullable: true
          properties:
            official_website: { type: string, nullable: true }
            dex_chart: { type: string, nullable: true }
            twitter: { type: string, nullable: true }
            telegram: { type: string, nullable: true }

